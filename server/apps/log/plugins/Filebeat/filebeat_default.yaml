# ================================== General ===================================
name: "filebeat-${node.ip}-${node.cloud_region}"
tags: ["bk-lite", "logstash"]

# ================================== Logging ===================================
logging.level: info
logging.to_files: true
logging.files:
  path: /opt/fusion-collectors/log/filebeat
  name: filebeat
  keepfiles: 7
  permissions: 0600

# ================================== Outputs ===================================
output.logstash:
  hosts: ["localhost:15044"]
  worker: 1
  bulk_max_size: 2048
  timeout: 30s
  max_retries: 3

# ================================== Inputs ===================================
filebeat.inputs:
# ================================== 健康检查模式 - 最小数据量 ==================================
- type: filestream
  id: filebeat-health-check
  enabled: true
  paths:
    - /opt/fusion-collectors/log/filebeat/filebeat-*.ndjson

  # 减少数据量配置
  scan_frequency: 300s  # 进一步降低到5分钟
  close_inactive: 60s   # 1分钟后关闭非活跃文件
  ignore_older: 30m     # 只处理30分钟内的文件

  # 移除ERROR过滤 - Filebeat正常运行时很少产生ERROR
  # 改为监控启动和关闭事件来验证功能
  include_lines: ['"message":"Starting filebeat"', '"message":"Stopping filebeat"', '"message":"filebeat stopped"']

  fields:
    log_type: "filebeat"
    component: "self"
    health_check_mode: true
    node_ip: "${node.ip}"
    cloud_region: "${node.cloud_region}"
  fields_under_root: false

  # 移除复杂的JSON解析器
  processors:
    - drop_fields:
        fields: ["agent.ephemeral_id", "ecs.version"]
        ignore_missing: true

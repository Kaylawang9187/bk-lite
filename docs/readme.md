# 单点登录接入指南

## 概述

本文档介绍如何通过 NATS 服务实现单点登录（SSO）接入，包括接口规范、配置步骤和注意事项。

## 1. 接口规范

### 1.1 登录接口

**接口名称**: `login`（固定名称）

**请求方式**: POST

**请求参数**: JSON 格式
```json
{
    "username": "用户名",
    "password": "密码"
}
```

**响应格式**: JSON 格式
```json
{
    "result": true,
    "data": {
        "username": "test",
        "display_name": "测试用户",
        "email": "test@test.com",
        "locale": "zh-Hans"
    }
}
```

**字段说明**:
- `result`: 布尔值，表示登录是否成功
- `username`: 用户名（必填）
- `display_name`: 用户显示名称（必填）
- `email`: 用户邮箱（可选）
- `locale`: 语言本地化设置（可选，默认为 zh-Hans）

### 1.2 数据同步接口

**接口名称**: `sync_data`

**请求方式**: GET

**请求参数**: 无

**响应格式**: JSON 格式
```json
{
    "result": true,
    "data": {
        "user_list": [
            {
                "username": "test",
                "display_name": "测试用户",
                "departments": ["group_1", "group_2"],
                "email": "test@test.com",
                "locale": "zh-Hans",
                "timezone": "Asia/Shanghai"
            }
        ],
        "group_list": [
            {
                "name": "组织根目录",
                "parent_id": null,
                "id": "group_0"
            },
            {
                "name": "部门1",
                "parent_id": "group_0",
                "id": "group_1"
            },
            {
                "name": "部门2",
                "parent_id": "group_0",
                "id": "group_2"
            }
        ]
    }
}
```

**字段说明**:

**用户信息字段**:
- `username`: 用户名（必填）
- `display_name`: 用户显示名称（必填）
- `departments`: 用户所属部门列表（数组）
- `email`: 用户邮箱（可选）
- `locale`: 语言本地化设置（可选）
- `timezone`: 时区设置（可选）

**组织信息字段**:
- `name`: 组织名称（必填）
- `id`: 组织唯一标识（必填）
- `parent_id`: 父组织ID（顶级组织必须为 null）

### 1.3 NATS 服务配置

1. **启动 NATS 服务**
   - 确保 NATS 服务正常运行
   - 配置好网络连接和端口

2. **定义命名空间**
   - 为该 NATS 服务定义唯一的命名空间
   - 命名空间将在后续配置中使用

**重要提醒**: 
- 顶级组织的 `parent_id` 必须设置为 `null`
- 所有组织必须有唯一的 `id` 标识
- 用户的 `departments` 数组中的值必须对应 `group_list` 中的 `id`

## 2. 系统配置步骤

### 2.1 登录系统管理

1. 打开系统管理应用
2. 导航至 **安全管理** → **认证源**
3. 点击 **添加认证源**

### 2.2 认证源配置

#### 基础配置
- **命名空间**: 填写步骤 1.3 中配置的 NATS 服务命名空间
- **认证源名称**: 为该认证源设置一个易识别的名称

#### 组织架构配置
- **根分组**: 指定顶级组织，同步的组织数据将作为该组织的子级
- **组织映射**: 确保同步的组织结构正确映射到系统中

#### 用户域配置
- **用户域**: 指定用户域名，同步的用户将自动分配到该域下
- **登录规则**: 用户可使用该域进行登录验证

#### 权限配置
- **默认角色**: 为新用户自动分配的默认角色
- **权限范围**: 定义用户的基础权限

**注意**: 默认角色配置仅对新增用户生效，已存在的用户角色不会被修改

### 2.3 同步配置

#### 定时同步设置
- **启用定时同步**: 选择是否开启自动同步
- **同步频率**: 固定为每日一次
- **同步时间**: 设置具体的同步执行时间

#### 手动同步
- 建议在完成配置后立即执行一次手动同步
- 验证数据同步是否正常工作

### 2.4 启用认证源

1. **保存配置**: 确保所有配置项都已正确填写
2. **启用认证源**: 将认证源状态设置为启用
3. **测试验证**: 进行登录测试以确保配置正确

## 3. 注意事项

### 3.1 数据一致性
- 确保用户的 `departments` 字段值与 `group_list` 中的 `id` 一致
- 组织层级关系必须正确，避免循环引用
- 用户名在系统中必须唯一

### 3.2 性能优化
- 大量用户同步时建议在业务低峰期执行
- 监控同步过程的性能指标
- 适当调整同步频率以平衡数据实时性和系统性能




